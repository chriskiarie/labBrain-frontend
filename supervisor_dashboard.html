<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LabBrain - Supervisor Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .red-theme { background: #fef2f2; }
        .red-gradient { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .red-accent { color: #ef4444; }
        .upload-area { border: 2px dashed #ef4444; background: #fef2f2; }
        .chat-modal { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .chat-container { background: white; border-radius: 20px; width: 98%; max-width: 700px; height: 80vh; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.18); }
        @media (min-width: 768px) {
            .chat-container { max-width: 900px; height: 85vh; }
        }
        .typing-indicator { display: none; }
        .typing-dots {
            display: inline-block;
            min-width: 2em;
            letter-spacing: 2px;
        }
        .typing-dots span {
            display: inline-block;
            width: 6px;
            height: 6px;
            margin: 0 2px;
            background: #ef4444;
            border-radius: 50%;
            opacity: 0.5;
            animation: typing-bounce 1.2s infinite both;
        }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing-bounce {
            0%, 80%, 100% { transform: scale(0.7); opacity: 0.5; }
            40% { transform: scale(1.2); opacity: 1; }
        }
        .ai-avatar {
            width: 48px;
            height: 48px;
            min-width: 48px;
            min-height: 48px;
            background: #10b981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            font-weight: 600;
            color: #fff;
            margin-right: 16px;
        }
    </style>
</head>
<body class="red-theme">
    <!-- Toast Notifications -->
    <div id="toastContainer" class="fixed bottom-6 right-6 z-50 flex flex-col gap-3 items-end"></div>
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-8 py-4 flex items-center justify-between shadow-sm">
        <div class="flex items-center gap-4">
            <img src="assets/KEBS_LOGO.jpg" alt="KEBS Logo" class="h-20 w-auto">
            <div>
                <h1 class="text-2xl font-extrabold text-gray-800 tracking-wide">LabBrain</h1>
                <p class="text-base text-gray-600">Supervisor Dashboard</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-right">
                <p class="font-semibold text-gray-800">Welcome, Christine</p>
                <p class="text-sm text-gray-600">Lab Supervisor</p>
            </div>
            <div class="w-10 h-10 rounded-full red-gradient flex items-center justify-center text-white font-semibold">C</div>
            <button class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors" onclick="logout()">Logout</button>
        </div>
    </header>

    <!-- Main Content -->
    <div id="mainDashboard">
        <main class="p-8">
            <!-- Welcome Section -->
            <div class="red-gradient text-white p-8 rounded-2xl mb-8">
                <h2 class="text-2xl font-bold mb-2">Knowledge Management Dashboard</h2>
                <p class="text-red-100">Upload documents, manage knowledge base, and test the AI assistant. You have full control over LabBrain's learning resources.</p>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 hover:shadow-lg transition-all cursor-pointer" onclick="openUploadDocuments()">
                    <div class="w-12 h-12 bg-red-50 rounded-xl flex items-center justify-center text-2xl mb-4">üì§</div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Upload Documents</h3>
                    <p class="text-gray-600">Add new procedures, standards, and guidelines to the knowledge base</p>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 hover:shadow-lg transition-all cursor-pointer" onclick="openAIAssistant()">
                    <div class="w-12 h-12 bg-red-50 rounded-xl flex items-center justify-center text-2xl mb-4">ü§ñ</div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Test AI Assistant</h3>
                    <p class="text-gray-600">Launch the chatbot to test responses and verify knowledge integration</p>
                </div>
                
                <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 hover:shadow-lg transition-all cursor-pointer" onclick="viewDocuments()">
                    <div class="w-12 h-12 bg-red-50 rounded-xl flex items-center justify-center text-2xl mb-4">üìÅ</div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Manage Documents</h3>
                    <p class="text-gray-600">View, edit, and organize existing documents in the knowledge base</p>
                </div>
            </div>

            <!-- AI Classification Section -->
            <div class="bg-white rounded-2xl p-8 shadow-md border border-gray-200">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">AI Document Classification & Analysis</h3>
                    <div class="flex gap-2">
                        <button onclick="analyzeAllDocuments()" id="analyzeBtn" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors font-semibold flex items-center gap-2">
                            <span>üîç</span>
                            Analyze
                        </button>
                        <button onclick="reanalyzeAllDocuments()" id="reanalyzeBtn" class="bg-gray-400 text-white px-4 py-3 rounded-lg flex items-center gap-2 cursor-not-allowed" disabled title="Re-analyze all documents">
                            <span style="font-size: 1.2em;">‚ôªÔ∏è</span>
                        </button>
                    </div>
                </div>
                <div id="classificationList">
                    <!-- Classifications will be loaded dynamically from uploaded documents -->
                </div>
            </div>
        </main>
    </div>

    <!-- Full-Page Manage Documents -->
    <div id="manageDocumentsPage" class="hidden">
        <div class="p-8">
            <div id="manageDocumentsList">
                <!-- Full-page table will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Full-Page AI Assistant -->
    <div id="aiAssistantPage" class="hidden">
        <div class="h-screen flex flex-col">
            <!-- AI Assistant Header -->
            <div class="red-gradient text-white p-6 flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <h2 class="text-2xl font-bold">LabBrain AI Assistant</h2>
                    <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm">Supervisor Test Mode</span>
                </div>
                <button class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-colors" onclick="closeAIAssistant()">
                    ‚Üê Back to Dashboard
                </button>
            </div>
            
            <!-- Chat Messages Area -->
            <div id="aiChatMessages" class="flex-1 p-6 overflow-y-auto bg-gray-50">
                <div class="flex items-start gap-3 mb-6">
                    <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white font-semibold text-sm">AI</div>
                    <div class="bg-white p-4 rounded-2xl border border-gray-200 max-w-3/4">
                        Hello! I'm LabBrain AI Assistant. I can answer questions based on the documents you've uploaded and analyzed.
                        <br><br>
                        <strong>My Knowledge Base:</strong>
                        <br>I have access to your uploaded documents and their AI analysis. I can help with questions about lab procedures, technical specifications, safety guidelines, and more.
                        <br><br>
                        <strong>How to use me:</strong>
                        <br>‚Ä¢ Ask specific questions about your uploaded documents
                        <br>‚Ä¢ I'll provide brief, direct answers based on the content
                        <br>‚Ä¢ I'll show you which documents I used as sources
                        <br><br>
                        Try asking me about any topic related to your uploaded documents!
                    </div>
                </div>
            </div>
            
            <!-- Typing Indicator -->
            <div id="aiTypingIndicator" class="typing-indicator p-4 bg-white border border-gray-200 rounded-2xl mx-6 mb-4">
                <span class="typing-dots text-gray-600">AI is typing</span>
            </div>
            
            <!-- Chat Input Area -->
            <div class="p-6 border-t border-gray-200 bg-white">
                <div class="flex gap-3 items-center">
                    <input type="text" id="aiChatInput" class="flex-1 p-4 border-2 border-gray-200 rounded-full focus:border-red-500 outline-none" placeholder="Test the AI with questions about uploaded documents..." onkeypress="handleAIChatKeyPress(event)">
                    <button class="w-12 h-12 red-gradient text-white rounded-full flex items-center justify-center hover:scale-105 transition-transform" onclick="sendAIMessage()">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Documents Modal -->
    <div id="uploadDocumentsModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-lg w-full max-w-lg p-8 relative">
            <button class="absolute top-4 right-4 text-2xl text-gray-400 hover:text-red-500" onclick="closeUploadDocuments()">&times;</button>
            <h2 class="text-2xl font-bold mb-6">Upload Documents</h2>
            <div class="upload-area rounded-xl p-8 text-center cursor-pointer border border-dashed border-red-400" onclick="document.getElementById('fileInput').click()">
                <div class="text-5xl mb-4">üìÑ</div>
                <h4 class="text-lg font-semibold text-gray-800 mb-2">Drop files here or click to upload</h4>
                <p class="text-gray-600">Support for PDF, DOC, DOCX, TXT files up to 10MB</p>
                <input type="file" id="fileInput" class="hidden" multiple accept=".pdf,.doc,.docx,.txt" onchange="handleFileUpload(event)">
            </div>
            <div id="uploadProgress" class="mt-4 hidden">
                <div class="flex justify-between text-sm text-gray-600 mb-2">
                    <span>Uploading...</span>
                    <span id="progressText">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="progressFill" class="red-gradient h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Documents Modal Table Format -->
    <div id="manageDocumentsModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-lg w-full max-w-3xl p-8 relative">
            <button class="absolute top-4 right-4 text-2xl text-gray-400 hover:text-red-500" onclick="closeManageDocuments()">&times;</button>
            <h2 class="text-2xl font-bold mb-6">Manage Documents</h2>
            <div id="manageDocumentsList">
                <div class="text-center text-gray-500">Loading documents...</div>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chatModal" class="chat-modal">
        <div class="chat-container">
            <div class="red-gradient text-white p-6 flex items-center justify-between">
                <h3 class="font-semibold text-lg">LabBrain AI Assistant - Supervisor Test Mode</h3>
                <button class="text-white text-2xl hover:text-gray-200" onclick="closeChatModal()">√ó</button>
            </div>
            
            <div id="chatMessages" class="flex-1 p-6 overflow-y-auto bg-gray-50">
                <div class="flex items-start gap-3 mb-6">
                    <div class="ai-avatar">AI</div>
                    <div class="bg-white p-4 rounded-2xl border border-gray-200 max-w-3/4">
                        Hello! I'm LabBrain AI Assistant. I can answer questions based on the documents you've uploaded and analyzed.
                        <br><br>
                        <strong>My Knowledge Base:</strong>
                        <br>I have access to your uploaded documents and their AI analysis. I can help with questions about lab procedures, technical specifications, safety guidelines, and more.
                        <br><br>
                        <strong>How to use me:</strong>
                        <br>‚Ä¢ Ask specific questions about your uploaded documents
                        <br>‚Ä¢ I'll provide brief, direct answers based on the content
                        <br>‚Ä¢ I'll show you which documents I used as sources
                        <br><br>
                        Try asking me about any topic related to your uploaded documents!
                    </div>
                </div>
            </div>
            
            <div id="typingIndicator" class="typing-indicator p-4 bg-white border border-gray-200 rounded-2xl mx-6 mb-4">
                <span class="typing-dots"><span></span><span></span><span></span></span> <span class="text-gray-600">AI is typing</span>
            </div>
            
            <div class="p-6 border-t border-gray-200 bg-white">
                <div class="flex gap-3 items-center">
                    <input type="text" id="chatInput" class="flex-1 p-4 border-2 border-gray-200 rounded-full focus:border-red-500 outline-none" placeholder="Test the AI with questions about uploaded documents..." onkeypress="handleChatKeyPress(event)">
                    <button class="w-12 h-12 red-gradient text-white rounded-full flex items-center justify-center hover:scale-105 transition-transform" onclick="sendMessage()">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load user data from localStorage
        let currentUser = null;
        
        function loadUserData() {
            const userData = localStorage.getItem('user');
            if (userData) {
                currentUser = JSON.parse(userData);
                updateUserDisplay();
            } else {
                // Redirect to login if no user data
                window.location.href = 'index.html';
            }
        }
        
        function updateUserDisplay() {
            if (currentUser) {
                // Update welcome message
                const welcomeElement = document.querySelector('.text-right p:first-child');
                if (welcomeElement) {
                    welcomeElement.textContent = `Welcome, ${currentUser.fullName || currentUser.username}`;
                }
                
                // Update role display
                const roleElement = document.querySelector('.text-right p:last-child');
                if (roleElement) {
                    roleElement.textContent = currentUser.role === 'supervisor' ? 'Lab Supervisor' : 'Lab User';
                }
                
                // Update avatar initial
                const avatarElement = document.querySelector('.w-10.h-10.rounded-full');
                if (avatarElement) {
                    avatarElement.textContent = (currentUser.fullName || currentUser.username).charAt(0).toUpperCase();
                }
            }
        }
        
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }
        
        // Load user data when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            loadUserData();
            await loadExistingDocuments();
        });

        async function loadExistingDocuments() {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;

                const response = await fetch('https://labbrain-backend.onrender.com/api/documents', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    const classificationList = document.getElementById('classificationList');
                    
                    // Clear existing classifications
                    classificationList.innerHTML = '';
                    
                    if (data.data.documents.length === 0) {
                        classificationList.innerHTML = `
                            <div class="text-center py-8 text-gray-500">
                                <div class="text-4xl mb-4">ü§ñ</div>
                                <h4 class="text-lg font-semibold mb-2">No documents to analyze</h4>
                                <p class="text-sm">Upload documents to see AI classification and analysis.</p>
                            </div>
                        `;
                        
                        // Update Analyze button state
                        updateAnalyzeButtonState(0, 0);
                        return;
                    }
                    
                    // Count analyzed vs unanalyzed documents
                    const totalDocs = data.data.documents.length;
                    const analyzedDocs = data.data.documents.filter(doc => doc.aiAnalysis && doc.aiAnalysis.category).length;
                    const unanalyzedDocs = totalDocs - analyzedDocs;
                    
                    // Update Analyze button state
                    updateAnalyzeButtonState(unanalyzedDocs, totalDocs);
                    
                    // Add AI classification for each document
                    data.data.documents.forEach(doc => {
                        const category = doc.aiAnalysis?.category || 'Uncategorized';
                        const keywords = doc.aiAnalysis?.keywords?.join(', ') || 'document, lab, information';
                        const description = doc.aiAnalysis?.description || 'Document uploaded to the knowledge base for AI analysis and retrieval.';
                        const status = doc.status || 'pending';
                        // Format category name for display
                        const formattedCategory = category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        // Status badge color
                        let statusColor = 'bg-yellow-100 text-yellow-800 border-yellow-300';
                        let statusText = 'Pending';
                        if (status === 'completed') { statusColor = 'bg-green-100 text-green-800 border-green-300'; statusText = 'Analyzed'; }
                        if (status === 'failed') { statusColor = 'bg-red-100 text-red-800 border-red-300'; statusText = 'Failed'; }
                        
                        const classificationElement = document.createElement('div');
                        classificationElement.className = 'bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4';
                        classificationElement.innerHTML = `
                            <div class="flex items-center justify-between mb-3">
                                <span class="font-semibold text-gray-800">${doc.originalName}</span>
                                <span class="bg-red-500 text-white px-3 py-1 rounded-full text-xs font-medium">${formattedCategory}</span>
                            </div>
                            <div class="flex items-center gap-2 mb-3">
                                <span class="text-xs px-2 py-1 rounded-full border ${statusColor}">${statusText}</span>
                                <span class="text-sm text-gray-600"><strong>Keywords:</strong> ${keywords}</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border-l-4 border-red-500">
                                <p class="text-sm text-gray-700"><strong>Document Description:</strong> ${description}</p>
                            </div>
                        `;
                        classificationList.appendChild(classificationElement);
                    });
                }
            } catch (error) {
                console.error('Error loading documents:', error);
                // Show error message in classification list
                const classificationList = document.getElementById('classificationList');
                
                classificationList.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                        <h4 class="text-lg font-semibold mb-2">Error loading classifications</h4>
                        <p class="text-sm">Please refresh the page to try again.</p>
                    </div>
                `;
            }
        }

        function updateAnalyzeButtonState(unanalyzedCount, totalCount) {
            const analyzeBtn = document.querySelector('button[onclick="analyzeAllDocuments()"]');
            const reanalyzeBtn = document.querySelector('button[onclick="reanalyzeAllDocuments()"]');
            if (!analyzeBtn || !reanalyzeBtn) return;
            
            if (unanalyzedCount === 0 && totalCount > 0) {
                // All documents analyzed - show gray disabled state for Analyze, enable Re-analyze
                analyzeBtn.innerHTML = '<span>‚úÖ</span> All Analyzed';
                analyzeBtn.disabled = true;
                analyzeBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                analyzeBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                
                reanalyzeBtn.disabled = false;
                reanalyzeBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                reanalyzeBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            } else {
                // Has unanalyzed documents - show green active state for Analyze, disable Re-analyze
                analyzeBtn.innerHTML = `<span>üîç</span> Analyze (${unanalyzedCount})`;
                analyzeBtn.disabled = false;
                analyzeBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                analyzeBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                
                reanalyzeBtn.disabled = true;
                reanalyzeBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                reanalyzeBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            }
        }

        function openUploadDocuments() {
            document.getElementById('uploadDocumentsModal').classList.remove('hidden');
        }

        function openAIAssistant() {
            document.getElementById('chatModal').style.display = 'flex';
        }

        function closeAIAssistant() {
            document.getElementById('chatModal').style.display = 'none';
        }

        function closeChatModal() {
            document.getElementById('chatModal').style.display = 'none';
        }

        function viewDocuments() {
            // Hide main dashboard and show full-page manage documents
            document.getElementById('mainDashboard').classList.add('hidden');
            document.getElementById('manageDocumentsPage').classList.remove('hidden');
            loadManageDocuments();
        }

        function closeManageDocuments() {
            // Show main dashboard and hide manage documents page
            document.getElementById('manageDocumentsPage').classList.add('hidden');
            document.getElementById('mainDashboard').classList.remove('hidden');
        }

        async function loadManageDocuments() {
            const list = document.getElementById('manageDocumentsList');
            list.innerHTML = '<div class="text-center text-gray-500 py-8">Loading documents...</div>';
            
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    list.innerHTML = '<div class="text-center text-red-500 py-8">Please log in to view documents.</div>';
                    return;
                }
                
                const response = await fetch('https://labbrain-backend.onrender.com/api/documents', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                
                if (!data.success || !data.data.documents.length) {
                    list.innerHTML = `
                        <div class="text-center py-12 text-gray-500">
                            <div class="text-6xl mb-4">üìÅ</div>
                            <h3 class="text-xl font-semibold mb-2">No documents uploaded yet</h3>
                            <p class="text-gray-600 mb-4">Upload your first document to get started with document management.</p>
                            <button onclick="openUploadDocuments()" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600">
                                Upload Document
                            </button>
                        </div>
                    `;
                    return;
                }
                
                // Create full-page table
                let html = `
                    <div class="bg-white rounded-lg shadow-sm border">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <div class="flex justify-between items-center">
                                <h2 class="text-xl font-semibold text-gray-800">Document Management</h2>
                                <div class="flex gap-2">
                                    <button onclick="openUploadDocuments()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 text-sm">
                                        + Upload New
                                    </button>
                                    <button onclick="closeManageDocuments()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 text-sm">
                                        ‚Üê Back to Dashboard
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Document Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Size</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Upload Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">`;
                
                data.data.documents.forEach((doc, index) => {
                    const hasAnalysis = doc.aiAnalysis && doc.aiAnalysis.category;
                    const fileSize = formatFileSize(doc.fileSize);
                    const uploadDate = new Date(doc.createdAt).toLocaleDateString();
                    
                    html += `
                        <tr class="hover:bg-gray-50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center mr-3">
                                        <span class="text-red-600 text-sm">üìÑ</span>
                                    </div>
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">${doc.originalName}</div>
                                        <div class="text-sm text-gray-500">ID: ${doc._id.substring(0, 8)}...</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    ${doc.fileType.toUpperCase()}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${fileSize}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${uploadDate}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                    doc.status === 'completed' ? 'bg-green-100 text-green-800' : 
                                    doc.status === 'processing' ? 'bg-yellow-100 text-yellow-800' : 
                                    'bg-red-100 text-red-800'
                                }">
                                    ${doc.status}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex gap-2">
                                    <a href="https://labbrain-backend.onrender.com/uploads/${doc.filename}" 
                                       target="_blank" 
                                       class="text-blue-600 hover:text-blue-900 underline text-sm">
                                        Open
                                    </a>
                                    ${hasAnalysis ? 
                                        `<button onclick="viewAnalysis('${doc._id}')" 
                                                 class="text-green-600 hover:text-green-900 underline text-sm">
                                            View Analysis
                                        </button>` : 
                                        `<button onclick="analyzeDocument('${doc._id}')" 
                                                 class="text-purple-600 hover:text-purple-900 underline text-sm">
                                            Analyze
                                        </button>`
                                    }
                                    <button onclick="deleteDocumentFromManage('${doc._id}')" 
                                            class="text-red-600 hover:text-red-900 underline text-sm">
                                        Delete
                                    </button>
                                </div>
                            </td>
                        </tr>`;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="px-6 py-4 border-t border-gray-200 bg-gray-50">
                            <div class="flex justify-between items-center text-sm text-gray-600">
                                <span>Total Documents: ${data.data.documents.length}</span>
                                <span>Last updated: ${new Date().toLocaleString()}</span>
                            </div>
                        </div>
                    </div>`;
                
                list.innerHTML = html;
                
            } catch (err) {
                list.innerHTML = `
                    <div class="text-center py-12 text-red-500">
                        <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                        <h3 class="text-xl font-semibold mb-2">Error loading documents</h3>
                        <p class="text-gray-600 mb-4">Please check your connection and try again.</p>
                        <button onclick="loadManageDocuments()" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        async function deleteDocumentFromManage(docId) {
            if (!confirm('Are you sure you want to delete this document?')) return;
            const token = localStorage.getItem('token');
            if (!token) return alert('Please log in.');
            try {
                const response = await fetch(`https://labbrain-backend.onrender.com/api/documents/${docId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.success) {
                    showToast('Document deleted successfully!', 'success');
                    loadManageDocuments();
                    loadExistingDocuments(); // refresh main dashboard too
                } else {
                    showToast('Delete failed: ' + (data.message || 'Unknown error'), 'error');
                }
            } catch (err) {
                showToast('Delete failed: ' + err.message, 'error');
            }
        }

        function viewAnalytics() {
            alert('AI Analytics dashboard - Coming soon!');
        }

        async function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length > 0) {
                document.getElementById('uploadProgress').classList.remove('hidden');
                await uploadFile(files[0]);
            }
        }

        async function uploadFile(file) {
            try {
                // Get token from localStorage
                const token = localStorage.getItem('token');
                if (!token) {
                    showToast('Please log in to upload documents.', 'error');
                    return;
                }

                // Create FormData
                const formData = new FormData();
                formData.append('file', file);

                // Show progress
                let progress = 0;
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                
                // Real progress simulation based on file size
                const totalSteps = Math.min(file.size / 10000, 50); // More realistic progress
                const progressInterval = setInterval(() => {
                    progress += (100 - progress) / totalSteps;
                    if (progress >= 95) {
                        clearInterval(progressInterval);
                    }
                    progressFill.style.width = progress + '%';
                    progressText.textContent = Math.round(progress) + '%';
                }, 100);

                // Upload to backend
                const response = await fetch('https://labbrain-backend.onrender.com/api/documents/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                clearInterval(progressInterval);
                progressFill.style.width = '100%';
                progressText.textContent = '100%';

                const data = await response.json();

                setTimeout(() => {
                    document.getElementById('uploadProgress').classList.add('hidden');
                    
                    if (data.success) {
                        // Reload all documents from server instead of just adding one
                        loadExistingDocuments();
                        updateClassification(data.data.document);
                        showToast('Document uploaded successfully!', 'success');
                    } else {
                        showToast('Upload failed: ' + (data.message || 'Unknown error'), 'error');
                    }
                }, 500);

            } catch (error) {
                document.getElementById('uploadProgress').classList.add('hidden');
                showToast('Upload failed: ' + error.message, 'error');
                console.error('Upload error:', error);
            }
        }

        function addNewDocument(file, documentData) {
            const documentList = document.getElementById('documentList');
            const newDoc = document.createElement('div');
            newDoc.className = 'flex items-center justify-between p-4 border border-gray-200 rounded-lg mb-2 bg-gray-50 hover:bg-gray-100 transition-colors';
            newDoc.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 bg-red-500 rounded-lg flex items-center justify-center text-white text-lg">üìÑ</div>
                    <div>
                        <h4 class="font-semibold text-gray-800">${file.name}</h4>
                        <p class="text-sm text-gray-600">${getFileType(file.name)} ‚Ä¢ ${formatFileSize(file.size)} ‚Ä¢ Uploaded just now</p>
                        <p class="text-xs text-gray-500">Status: ${documentData.status}</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600" onclick="editDocument('${documentData._id}')">Edit</button>
                    <button class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600" onclick="deleteDocument('${documentData._id}')">Delete</button>
                </div>
            `;
            documentList.insertBefore(newDoc, documentList.firstChild);
        }

        function getFileType(filename) {
            return filename.split('.').pop().toUpperCase();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateClassification(documentData) {
            // Reload all classifications from server instead of just adding one
            loadExistingDocuments();
        }

        function editDocument(docId) {
            alert(`Edit document: ${docId} - Coming soon!`);
        }

        async function deleteDocument(docId) {
            if (confirm('Are you sure you want to delete this document? This action cannot be undone.')) {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('Please log in to delete documents.');
                        return;
                    }

                    const response = await fetch(`https://labbrain-backend.onrender.com/api/documents/${docId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert('Document deleted successfully!');
                        // Reload documents to reflect the deletion
                        loadExistingDocuments();
                    } else {
                        alert('Delete failed: ' + (data.message || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Delete failed: ' + error.message);
                    console.error('Delete error:', error);
                }
            }
        }

        function handleAIChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendAIMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message === '') return;
            
            addMessage(message, 'user');
            input.value = '';
            
            document.getElementById('typingIndicator').style.display = 'block';
            
            try {
                // Get token from localStorage
                const token = localStorage.getItem('token');
                if (!token) {
                    document.getElementById('typingIndicator').style.display = 'none';
                    addMessage('Please log in to use the AI chat.', 'bot');
                    return;
                }
                
                // Call the AI backend
                const response = await fetch('https://labbrain-backend.onrender.com/api/ai/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ message })
                });
                
                const data = await response.json();
                
                document.getElementById('typingIndicator').style.display = 'none';
                
                if (data.success) {
                    addMessage(data.data.response, 'bot');
                    
                    // Add source information if available
                    if (data.data.sources && data.data.sources.length > 0) {
                        const sources = data.data.sources.map(s => s.title).join(', ');
                        addMessage(`üìö Sources: ${sources}`, 'system');
                    }
                } else {
                    addMessage('Sorry, I encountered an error. Please try again.', 'bot');
                }
            } catch (error) {
                document.getElementById('typingIndicator').style.display = 'none';
                addMessage('Sorry, I encountered an error. Please try again.', 'bot');
                console.error('Chat error:', error);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message === '') return;
            
            addMessage(message, 'user');
            input.value = '';
            
            document.getElementById('typingIndicator').style.display = 'block';
            
            try {
                // Get token from localStorage
                const token = localStorage.getItem('token');
                if (!token) {
                    document.getElementById('typingIndicator').style.display = 'none';
                    addMessage('Please log in to use the AI chat.', 'bot');
                    return;
                }
                
                // Call the AI backend
                const response = await fetch('https://labbrain-backend.onrender.com/api/ai/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ message })
                });
                
                const data = await response.json();
                
                document.getElementById('typingIndicator').style.display = 'none';
                
                if (data.success) {
                    addMessage(data.data.response, 'bot');
                    
                    // Add source information if available
                    if (data.data.sources && data.data.sources.length > 0) {
                        const sources = data.data.sources.map(s => s.title).join(', ');
                        addMessage(`üìö Sources: ${sources}`, 'system');
                    }
                } else {
                    addMessage('Sorry, I encountered an error. Please try again.', 'bot');
                }
            } catch (error) {
                document.getElementById('typingIndicator').style.display = 'none';
                addMessage('Sorry, I encountered an error. Please try again.', 'bot');
                console.error('Chat error:', error);
            }
        }

        function addMessage(content, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start gap-3 mb-6';
            if (sender === 'user') messageDiv.className += ' flex-row-reverse';
            
            const avatar = document.createElement('div');
            if (sender === 'user') {
                avatar.className = 'w-10 h-10 rounded-full flex items-center justify-center text-white font-semibold text-sm';
                avatar.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                avatar.textContent = 'C';
            } else {
                avatar.className = 'ai-avatar';
                avatar.textContent = 'AI';
            }
            
            const messageContent = document.createElement('div');
            messageContent.className = 'p-4 rounded-2xl max-w-3/4';
            messageContent.style.background = sender === 'user' ? 'linear-gradient(135deg, #ef4444, #dc2626)' : 'white';
            messageContent.style.color = sender === 'user' ? 'white' : '#374151';
            messageContent.style.border = sender === 'user' ? 'none' : '1px solid #e5e7eb';
            messageContent.textContent = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function generateSupervisorResponse(userMessage) {
            const message = userMessage.toLowerCase();
            
            if (message.includes('upload') || message.includes('document')) {
                return "I can see you've uploaded several documents to the knowledge base: ISO 17025 Calibration Procedures, Equipment Troubleshooting Guide, and Quality Control Standards. These documents are now part of my training data and I can reference them when answering questions.";
            }
            else if (message.includes('iso') || message.includes('17025')) {
                return "Based on the ISO 17025 Calibration Procedures document in the knowledge base, I can provide detailed information about calibration requirements, documentation standards, and compliance procedures. The document covers both management and technical requirements for testing and calibration laboratories.";
            }
            else if (message.includes('troubleshoot') || message.includes('equipment')) {
                return "I have access to the Equipment Troubleshooting Guide which contains comprehensive diagnostic procedures, common issues, and maintenance schedules. I can help users with equipment problems, error diagnosis, and preventive maintenance procedures.";
            }
            else if (message.includes('quality') || message.includes('control')) {
                return "The Quality Control Standards document provides detailed guidelines for quality assurance, control procedures, and compliance requirements. I can assist with quality control protocols, standards implementation, and quality metrics analysis.";
            }
            else if (message.includes('test') || message.includes('knowledge')) {
                return "I'm successfully integrated with the knowledge base you've uploaded. I can now provide accurate, document-based responses to lab-related questions. The AI classification system has categorized the documents appropriately for optimal retrieval.";
            }
            else {
                return "As a supervisor, I have access to all the documents you've uploaded to the knowledge base. I can provide detailed, accurate responses based on the ISO 17025 procedures, troubleshooting guides, and quality control standards. What specific aspect would you like me to explain?";
            }
        }

        function closeUploadDocuments() {
            document.getElementById('uploadDocumentsModal').classList.add('hidden');
        }

        // AI Analysis Functions
        async function analyzeAllDocuments() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    showToast('Please log in to analyze documents.', 'error');
                    return;
                }

                // Get all documents first
                const response = await fetch('https://labbrain-backend.onrender.com/api/documents', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                
                if (!data.success || !data.data.documents.length) {
                    showToast('No documents found to analyze.', 'error');
                    return;
                }

                // Get documents that haven't been analyzed yet
                const unanalyzedDocs = data.data.documents.filter(doc => !doc.aiAnalysis || !doc.aiAnalysis.category);
                
                if (unanalyzedDocs.length === 0) {
                    showToast('All documents have already been analyzed!', 'success');
                    return;
                }

                // Show loading state
                const analyzeBtn = document.querySelector('button[onclick="analyzeAllDocuments()"]');
                const originalText = analyzeBtn.innerHTML;
                analyzeBtn.innerHTML = '<span>‚è≥</span> Analyzing...';
                analyzeBtn.disabled = true;
                analyzeBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                analyzeBtn.classList.add('bg-gray-400');

                // Analyze each unanalyzed document
                let successCount = 0;
                let errorCount = 0;

                for (const doc of unanalyzedDocs) {
                    try {
                        const analysisResponse = await fetch('https://labbrain-backend.onrender.com/api/ai/analyze', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ documentId: doc._id })
                        });

                        const analysisData = await analysisResponse.json();
                        
                        if (analysisData.success) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    } catch (error) {
                        console.error(`Error analyzing document ${doc.originalName}:`, error);
                        errorCount++;
                    }
                }

                // Show results
                if (successCount > 0) {
                    showToast(`Analysis complete! Successfully analyzed ${successCount} document(s).${errorCount > 0 ? ` ${errorCount} document(s) failed.` : ''}`, 'success');
                    // Reload the classifications to show new results and update button state
                    loadExistingDocuments();
                } else {
                    showToast(`Analysis failed for all documents. Please try again.`, 'error');
                    // Reset button to original state
                    analyzeBtn.innerHTML = originalText;
                    analyzeBtn.disabled = false;
                    analyzeBtn.classList.remove('bg-gray-400');
                    analyzeBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                }

            } catch (error) {
                console.error('Analyze all documents error:', error);
                showToast('Error analyzing documents: ' + error.message, 'error');
                
                // Reset button
                const analyzeBtn = document.querySelector('button[onclick="analyzeAllDocuments()"]');
                if (analyzeBtn) {
                    analyzeBtn.innerHTML = '<span>üîç</span> Analyze';
                    analyzeBtn.disabled = false;
                    analyzeBtn.classList.remove('bg-gray-400');
                    analyzeBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                }
            }
        }

        // AI Analysis Functions
        async function analyzeDocument(docId) {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    showToast('Please log in to analyze documents.', 'error');
                    return;
                }

                // Show loading state
                const analyzeBtn = event.target;
                const originalText = analyzeBtn.textContent;
                analyzeBtn.textContent = 'Analyzing...';
                analyzeBtn.disabled = true;

                const response = await fetch('https://labbrain-backend.onrender.com/api/ai/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ documentId: docId })
                });

                const data = await response.json();

                // Reset button
                analyzeBtn.textContent = originalText;
                analyzeBtn.disabled = false;

                if (data.success) {
                    showToast('Document analyzed successfully!', 'success');
                    // Refresh the documents list to show the new analysis
                    loadManageDocuments();
                    loadExistingDocuments();
                } else {
                    showToast('Analysis failed: ' + (data.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Analysis error:', error);
                showToast('Analysis failed: ' + error.message, 'error');
                
                // Reset button
                const analyzeBtn = event.target;
                analyzeBtn.textContent = 'Analyze';
                analyzeBtn.disabled = false;
            }
        }

        async function viewAnalysis(docId) {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    showToast('Please log in to view analysis.', 'error');
                    return;
                }

                // Get document details
                const response = await fetch(`https://labbrain-backend.onrender.com/api/documents/${docId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success && data.data.document.aiAnalysis) {
                    const analysis = data.data.document.aiAnalysis;
                    const doc = data.data.document;
                    
                    // Show analysis modal
                    showAnalysisModal(doc, analysis);
                } else {
                    showToast('No analysis found for this document.', 'error');
                }
            } catch (error) {
                console.error('View analysis error:', error);
                showToast('Error loading analysis: ' + error.message, 'error');
            }
        }

        function showAnalysisModal(doc, analysis) {
            // Create modal HTML
            const modalHTML = `
                <div id="analysisModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-800">AI Analysis Results</h2>
                            <button onclick="closeAnalysisModal()" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <h3 class="font-semibold text-gray-800 mb-2">Document: ${doc.originalName}</h3>
                            <p class="text-sm text-gray-600">Type: ${doc.fileType.toUpperCase()} ‚Ä¢ Analyzed: ${new Date(analysis.analyzedAt).toLocaleString()}</p>
                        </div>

                        <div class="mb-4">
                            <h4 class="font-semibold text-gray-800 mb-2">Category</h4>
                            <p class="text-gray-700 bg-gray-50 p-3 rounded-lg">${analysis.category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</p>
                        </div>

                        <div class="mb-4">
                            <h4 class="font-semibold text-gray-800 mb-2">Keywords</h4>
                            <div class="flex flex-wrap gap-2">
                                ${analysis.keywords.map(keyword => 
                                    `<span class="bg-gray-100 text-gray-700 px-2 py-1 rounded-full text-sm">${keyword}</span>`
                                ).join('')}
                            </div>
                        </div>

                        <div class="mb-4">
                            <h4 class="font-semibold text-gray-800 mb-2">Description</h4>
                            <p class="text-gray-700 bg-gray-50 p-3 rounded-lg">${analysis.description}</p>
                        </div>

                        ${analysis.mainPoints && analysis.mainPoints.length > 0 ? `
                        <div class="mb-4">
                            <h4 class="font-semibold text-gray-800 mb-2">Main Points</h4>
                            <ul class="list-disc list-inside text-gray-700 space-y-1">
                                ${analysis.mainPoints.map(point => `<li>${point}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}

                        ${analysis.error ? `
                        <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg">
                            <h4 class="font-semibold text-yellow-800 mb-1">Analysis Note</h4>
                            <p class="text-yellow-700 text-sm">${analysis.error}</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeAnalysisModal() {
            const modal = document.getElementById('analysisModal');
            if (modal) {
                modal.remove();
            }
        }

        // Toast Notification System
        function showToast(message, type = 'success', duration = 3500) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `px-5 py-3 rounded-lg shadow-lg text-white font-medium flex items-center gap-2 animate-fade-in ${type === 'success' ? 'bg-green-600' : 'bg-red-600'}`;
            toast.innerHTML = type === 'success' ? `<span>‚úîÔ∏è</span> <span>${message}</span>` : `<span>‚ùå</span> <span>${message}</span>`;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('animate-fade-out');
                setTimeout(() => toast.remove(), 400);
            }, duration);
        }
        // Toast Animations
        const style = document.createElement('style');
        style.innerHTML = `
        @keyframes fade-in { from { opacity: 0; transform: translateY(20px);} to { opacity: 1; transform: translateY(0);} }
        @keyframes fade-out { from { opacity: 1; } to { opacity: 0; transform: translateY(20px);} }
        .animate-fade-in { animation: fade-in 0.4s cubic-bezier(.4,0,.2,1) both; }
        .animate-fade-out { animation: fade-out 0.4s cubic-bezier(.4,0,.2,1) both; }
        `;
        document.head.appendChild(style);

        async function reanalyzeAllDocuments() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    showToast('Please log in to re-analyze documents.', 'error');
                    return;
                }
                // Get all documents
                const response = await fetch('https://labbrain-backend.onrender.com/api/documents', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (!data.success || !data.data.documents.length) {
                    showToast('No documents found to re-analyze.', 'error');
                    return;
                }
                // Show loading state
                const reanalyzeBtn = document.querySelector('button[onclick="reanalyzeAllDocuments()"]');
                const originalText = reanalyzeBtn.innerHTML;
                reanalyzeBtn.innerHTML = '<span>‚ôªÔ∏è</span> Re-analyzing...';
                reanalyzeBtn.disabled = true;
                reanalyzeBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                reanalyzeBtn.classList.add('bg-gray-400');
                let successCount = 0;
                let errorCount = 0;
                for (const doc of data.data.documents) {
                    try {
                        const analysisResponse = await fetch('https://labbrain-backend.onrender.com/api/ai/analyze', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ documentId: doc._id })
                        });
                        const analysisData = await analysisResponse.json();
                        if (analysisData.success) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    } catch (error) {
                        errorCount++;
                    }
                }
                // Show results
                if (successCount > 0) {
                    showToast(`Re-analysis complete! Successfully re-analyzed ${successCount} document(s).${errorCount > 0 ? ` ${errorCount} document(s) failed.` : ''}`, 'success');
                    loadExistingDocuments();
                    // Reset button to default
                    reanalyzeBtn.innerHTML = '<span style="font-size: 1.2em;">‚ôªÔ∏è</span>';
                    reanalyzeBtn.disabled = false;
                    reanalyzeBtn.classList.remove('bg-gray-400');
                    reanalyzeBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                } else {
                    showToast('Re-analysis failed for all documents. Please try again.', 'error');
                    reanalyzeBtn.innerHTML = '<span style="font-size: 1.2em;">‚ôªÔ∏è</span>';
                    reanalyzeBtn.disabled = false;
                    reanalyzeBtn.classList.remove('bg-gray-400');
                    reanalyzeBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                }
            } catch (error) {
                showToast('Error re-analyzing documents: ' + error.message, 'error');
                const reanalyzeBtn = document.querySelector('button[onclick="reanalyzeAllDocuments()"]');
                if (reanalyzeBtn) {
                    reanalyzeBtn.innerHTML = '<span>‚ôªÔ∏è</span>';
                    reanalyzeBtn.disabled = false;
                    reanalyzeBtn.classList.remove('bg-gray-400');
                    reanalyzeBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                }
            }
        }
    </script>
</body>
</html> 
