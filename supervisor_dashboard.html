<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LabBrain - Supervisor Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .red-theme { background: #fef2f2; }
        .red-gradient { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .red-accent { color: #ef4444; }
        .upload-area { border: 2px dashed #ef4444; background: #fef2f2; }
        .chat-modal { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .chat-container { background: white; border-radius: 20px; width: 90%; max-width: 800px; height: 80vh; display: flex; flex-direction: column; overflow: hidden; }
        .typing-indicator { display: none; }
        .typing-dots::after { content: ''; animation: typing 1.5s infinite; }
        @keyframes typing { 0%, 20% { content: ''; } 40% { content: '.'; } 60% { content: '..'; } 80%, 100% { content: '...'; } }
    </style>
</head>
<body class="red-theme">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-8 py-4 flex items-center justify-between shadow-sm">
        <div class="flex items-center gap-4">
            <img src="assets/KEBS_LOGO.jpg" alt="KEBS Logo" class="h-16 w-auto">
            <div>
                <h1 class="text-xl font-bold text-gray-800">LabBrain</h1>
                <p class="text-sm text-gray-600">Supervisor Dashboard</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-right">
                <p class="font-semibold text-gray-800">Welcome, Christine</p>
                <p class="text-sm text-gray-600">Lab Supervisor</p>
            </div>
            <div class="w-10 h-10 rounded-full red-gradient flex items-center justify-center text-white font-semibold">C</div>
            <button class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors" onclick="logout()">Logout</button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="p-8">
        <!-- Welcome Section -->
        <div class="red-gradient text-white p-8 rounded-2xl mb-8">
            <h2 class="text-2xl font-bold mb-2">Knowledge Management Dashboard</h2>
            <p class="text-red-100">Upload documents, manage knowledge base, and test the AI assistant. You have full control over LabBrain's learning resources.</p>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 hover:shadow-lg transition-all cursor-pointer" onclick="openUpload()">
                <div class="w-12 h-12 bg-red-50 rounded-xl flex items-center justify-center text-2xl mb-4">üì§</div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Upload Documents</h3>
                <p class="text-gray-600">Add new procedures, standards, and guidelines to the knowledge base</p>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 hover:shadow-lg transition-all cursor-pointer" onclick="openChatModal()">
                <div class="w-12 h-12 bg-red-50 rounded-xl flex items-center justify-center text-2xl mb-4">ü§ñ</div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Test AI Assistant</h3>
                <p class="text-gray-600">Launch the chatbot to test responses and verify knowledge integration</p>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 hover:shadow-lg transition-all cursor-pointer" onclick="viewDocuments()">
                <div class="w-12 h-12 bg-red-50 rounded-xl flex items-center justify-center text-2xl mb-4">üìÅ</div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Manage Documents</h3>
                <p class="text-gray-600">View, edit, and organize existing documents in the knowledge base</p>
            </div>
            
            <div class="bg-white p-6 rounded-xl shadow-md border border-gray-200 hover:shadow-lg transition-all cursor-pointer" onclick="viewAnalytics()">
                <div class="w-12 h-12 bg-red-50 rounded-xl flex items-center justify-center text-2xl mb-4">üìä</div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">AI Analytics</h3>
                <p class="text-gray-600">Monitor AI performance and document classification insights</p>
            </div>
        </div>

        <!-- Document Upload Section -->
        <div class="bg-white rounded-2xl p-8 shadow-md border border-gray-200 mb-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Document Upload</h3>
            <div class="upload-area rounded-xl p-8 text-center cursor-pointer" onclick="document.getElementById('fileInput').click()">
                <div class="text-5xl mb-4">üìÑ</div>
                <h4 class="text-lg font-semibold text-gray-800 mb-2">Drop files here or click to upload</h4>
                <p class="text-gray-600">Support for PDF, DOC, DOCX, TXT files up to 10MB</p>
                <input type="file" id="fileInput" class="hidden" multiple accept=".pdf,.doc,.docx,.txt" onchange="handleFileUpload(event)">
            </div>
            <div id="uploadProgress" class="mt-4 hidden">
                <div class="flex justify-between text-sm text-gray-600 mb-2">
                    <span>Uploading...</span>
                    <span id="progressText">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="progressFill" class="red-gradient h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Document Management -->
        <div class="bg-white rounded-2xl p-8 shadow-md border border-gray-200 mb-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Knowledge Base Documents</h3>
            <div id="documentList">
                <!-- Documents will be loaded dynamically from the server -->
            </div>
        </div>

        <!-- AI Classification Section -->
        <div class="bg-white rounded-2xl p-8 shadow-md border border-gray-200">
            <h3 class="text-xl font-bold text-gray-800 mb-4">AI Document Classification & Analysis</h3>
            <div id="classificationList">
                <!-- Classifications will be loaded dynamically from uploaded documents -->
            </div>
        </div>
    </main>

    <!-- Chat Modal -->
    <div id="chatModal" class="chat-modal">
        <div class="chat-container">
            <div class="red-gradient text-white p-6 flex items-center justify-between">
                <h3 class="font-semibold text-lg">LabBrain AI Assistant - Supervisor Test Mode</h3>
                <button class="text-white text-2xl hover:text-gray-200" onclick="closeChatModal()">√ó</button>
            </div>
            
            <div id="chatMessages" class="flex-1 p-6 overflow-y-auto bg-gray-50">
                <div class="flex items-start gap-3 mb-6">
                    <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white font-semibold text-sm">AI</div>
                    <div class="bg-white p-4 rounded-2xl border border-gray-200 max-w-3/4">
                        Hello Christine! I'm in Supervisor Test Mode. I can access all the documents you've uploaded to the knowledge base. 
                        <br><br>
                        <strong>Available knowledge:</strong>
                        <br>‚Ä¢ ISO 17025 Calibration Procedures
                        <br>‚Ä¢ Equipment Troubleshooting Guide  
                        <br>‚Ä¢ Quality Control Standards
                        <br><br>
                        Test me with any questions about these documents or general lab topics!
                    </div>
                </div>
            </div>
            
            <div id="typingIndicator" class="typing-indicator p-4 bg-white border border-gray-200 rounded-2xl mx-6 mb-4">
                <span class="typing-dots text-gray-600">AI is typing</span>
            </div>
            
            <div class="p-6 border-t border-gray-200 bg-white">
                <div class="flex gap-3 items-center">
                    <input type="text" id="chatInput" class="flex-1 p-4 border-2 border-gray-200 rounded-full focus:border-red-500 outline-none" placeholder="Test the AI with questions about uploaded documents..." onkeypress="handleChatKeyPress(event)">
                    <button class="w-12 h-12 red-gradient text-white rounded-full flex items-center justify-center hover:scale-105 transition-transform" onclick="sendMessage()">‚û§</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add a modal for Manage Documents -->
    <div id="manageDocumentsModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-lg w-full max-w-3xl p-8 relative">
            <button class="absolute top-4 right-4 text-2xl text-gray-400 hover:text-red-500" onclick="closeManageDocuments()">&times;</button>
            <h2 class="text-2xl font-bold mb-6">Manage Documents</h2>
            <div id="manageDocumentsList">
                <div class="text-center text-gray-500">Loading documents...</div>
            </div>
        </div>
    </div>

    <script>
        // Load user data from localStorage
        let currentUser = null;
        
        function loadUserData() {
            const userData = localStorage.getItem('user');
            if (userData) {
                currentUser = JSON.parse(userData);
                updateUserDisplay();
            } else {
                // Redirect to login if no user data
                window.location.href = 'index.html';
            }
        }
        
        function updateUserDisplay() {
            if (currentUser) {
                // Update welcome message
                const welcomeElement = document.querySelector('.text-right p:first-child');
                if (welcomeElement) {
                    welcomeElement.textContent = `Welcome, ${currentUser.fullName || currentUser.username}`;
                }
                
                // Update role display
                const roleElement = document.querySelector('.text-right p:last-child');
                if (roleElement) {
                    roleElement.textContent = currentUser.role === 'supervisor' ? 'Lab Supervisor' : 'Lab User';
                }
                
                // Update avatar initial
                const avatarElement = document.querySelector('.w-10.h-10.rounded-full');
                if (avatarElement) {
                    avatarElement.textContent = (currentUser.fullName || currentUser.username).charAt(0).toUpperCase();
                }
            }
        }
        
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }
        
        // Load user data when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            loadUserData();
            await loadExistingDocuments();
        });

        async function loadExistingDocuments() {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;

                const response = await fetch('https://labbrain-backend.onrender.com/api/documents', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    const documentList = document.getElementById('documentList');
                    const classificationList = document.getElementById('classificationList');
                    
                    // Clear existing demo documents
                    documentList.innerHTML = '';
                    classificationList.innerHTML = '';
                    
                    if (data.data.documents.length === 0) {
                        // Show message when no documents are found
                        documentList.innerHTML = `
                            <div class="text-center py-8 text-gray-500">
                                <div class="text-4xl mb-4">üìÅ</div>
                                <h4 class="text-lg font-semibold mb-2">No documents uploaded yet</h4>
                                <p class="text-sm">Upload your first document to get started with the knowledge base.</p>
                            </div>
                        `;
                        
                        classificationList.innerHTML = `
                            <div class="text-center py-8 text-gray-500">
                                <div class="text-4xl mb-4">ü§ñ</div>
                                <h4 class="text-lg font-semibold mb-2">No documents to analyze</h4>
                                <p class="text-sm">Upload documents to see AI classification and analysis.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // Add real documents
                    data.data.documents.forEach(doc => {
                        const docElement = document.createElement('div');
                        docElement.className = 'flex items-center justify-between p-4 border border-gray-200 rounded-lg mb-2 bg-gray-50 hover:bg-gray-100 transition-colors';
                        docElement.innerHTML = `
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 bg-red-500 rounded-lg flex items-center justify-center text-white text-lg">üìÑ</div>
                                <div>
                                    <h4 class="font-semibold text-gray-800">${doc.originalName}</h4>
                                    <p class="text-sm text-gray-600">${doc.fileType.toUpperCase()} ‚Ä¢ ${formatFileSize(doc.fileSize)} ‚Ä¢ Uploaded ${new Date(doc.createdAt).toLocaleDateString()}</p>
                                    <p class="text-xs text-gray-500">Status: ${doc.status}</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600" onclick="editDocument('${doc._id}')">Edit</button>
                                <button class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600" onclick="deleteDocument('${doc._id}')">Delete</button>
                            </div>
                        `;
                        documentList.appendChild(docElement);
                        
                        // Add AI classification for each document
                        const category = doc.aiAnalysis?.category || 'General Document';
                        const confidence = doc.aiAnalysis?.confidence || '85%';
                        const keywords = doc.aiAnalysis?.keywords?.join(', ') || 'document, lab, information';
                        const description = doc.aiAnalysis?.description || 'Document uploaded to the knowledge base for AI analysis and retrieval.';
                        
                        const classificationElement = document.createElement('div');
                        classificationElement.className = 'bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4';
                        classificationElement.innerHTML = `
                            <div class="flex items-center justify-between mb-2">
                                <span class="font-semibold text-gray-800">${doc.originalName}</span>
                                <span class="bg-red-500 text-white px-3 py-1 rounded-full text-xs font-medium">${category}</span>
                            </div>
                            <div class="text-sm text-gray-600 mb-2">Confidence: ${confidence} ‚Ä¢ Keywords: ${keywords}</div>
                            <div class="bg-white p-3 rounded-lg border-l-4 border-red-500">
                                <p class="text-sm text-gray-700"><strong>Document Description:</strong> ${description}</p>
                            </div>
                        `;
                        classificationList.appendChild(classificationElement);
                    });
                }
            } catch (error) {
                console.error('Error loading documents:', error);
                // Show error message in document list
                const documentList = document.getElementById('documentList');
                const classificationList = document.getElementById('classificationList');
                
                documentList.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                        <h4 class="text-lg font-semibold mb-2">Error loading documents</h4>
                        <p class="text-sm">Please refresh the page to try again.</p>
                    </div>
                `;
                
                classificationList.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                        <h4 class="text-lg font-semibold mb-2">Error loading classifications</h4>
                        <p class="text-sm">Please refresh the page to try again.</p>
                    </div>
                `;
            }
        }

        function openUpload() {
            document.getElementById('fileInput').click();
        }

        function openChatModal() {
            document.getElementById('chatModal').style.display = 'flex';
        }

        function closeChatModal() {
            document.getElementById('chatModal').style.display = 'none';
        }

        function viewDocuments() {
            document.getElementById('manageDocumentsModal').classList.remove('hidden');
            loadManageDocuments();
        }

        function closeManageDocuments() {
            document.getElementById('manageDocumentsModal').classList.add('hidden');
        }

        async function loadManageDocuments() {
            const list = document.getElementById('manageDocumentsList');
            list.innerHTML = '<div class="text-center text-gray-500">Loading documents...</div>';
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    list.innerHTML = '<div class="text-center text-red-500">Please log in to view documents.</div>';
                    return;
                }
                const response = await fetch('https://labbrain-backend.onrender.com/api/documents', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (!data.success || !data.data.documents.length) {
                    list.innerHTML = '<div class="text-center text-gray-500">No documents uploaded yet.</div>';
                    return;
                }
                let html = `<table class='w-full text-left'><thead><tr><th>File Name</th><th>Type</th><th>Date</th><th>Actions</th></tr></thead><tbody>`;
                data.data.documents.forEach(doc => {
                    html += `<tr class='border-b'>
                        <td>${doc.originalName}</td>
                        <td>${doc.fileType.toUpperCase()}</td>
                        <td>${new Date(doc.createdAt).toLocaleString()}</td>
                        <td>
                            <a href="https://labbrain-backend.onrender.com/uploads/${doc.filename}" target="_blank" class="text-blue-600 underline mr-2">Open</a>
                            <button onclick="deleteDocumentFromManage('${doc._id}')" class="text-red-600 underline">Delete</button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                list.innerHTML = html;
            } catch (err) {
                list.innerHTML = '<div class="text-center text-red-500">Error loading documents.</div>';
            }
        }

        async function deleteDocumentFromManage(docId) {
            if (!confirm('Are you sure you want to delete this document?')) return;
            const token = localStorage.getItem('token');
            if (!token) return alert('Please log in.');
            try {
                const response = await fetch(`https://labbrain-backend.onrender.com/api/documents/${docId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (data.success) {
                    alert('Document deleted successfully!');
                    loadManageDocuments();
                    loadExistingDocuments(); // refresh main dashboard too
                } else {
                    alert('Delete failed: ' + (data.message || 'Unknown error'));
                }
            } catch (err) {
                alert('Delete failed: ' + err.message);
            }
        }

        function viewAnalytics() {
            alert('AI Analytics dashboard - Coming soon!');
        }

        async function handleFileUpload(event) {
            const files = event.target.files;
            if (files.length > 0) {
                document.getElementById('uploadProgress').classList.remove('hidden');
                await uploadFile(files[0]);
            }
        }

        async function uploadFile(file) {
            try {
                // Get token from localStorage
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('Please log in to upload documents.');
                    return;
                }

                // Create FormData
                const formData = new FormData();
                formData.append('file', file);

                // Show progress
                let progress = 0;
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                
                // Real progress simulation based on file size
                const totalSteps = Math.min(file.size / 10000, 50); // More realistic progress
                const progressInterval = setInterval(() => {
                    progress += (100 - progress) / totalSteps;
                    if (progress >= 95) {
                        clearInterval(progressInterval);
                    }
                    progressFill.style.width = progress + '%';
                    progressText.textContent = Math.round(progress) + '%';
                }, 100);

                // Upload to backend
                const response = await fetch('https://labbrain-backend.onrender.com/api/documents/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                clearInterval(progressInterval);
                progressFill.style.width = '100%';
                progressText.textContent = '100%';

                const data = await response.json();

                setTimeout(() => {
                    document.getElementById('uploadProgress').classList.add('hidden');
                    
                    if (data.success) {
                        // Reload all documents from server instead of just adding one
                        loadExistingDocuments();
                        updateClassification(data.data.document);
                        alert('Document uploaded successfully!');
                    } else {
                        alert('Upload failed: ' + (data.message || 'Unknown error'));
                    }
                }, 500);

            } catch (error) {
                document.getElementById('uploadProgress').classList.add('hidden');
                alert('Upload failed: ' + error.message);
                console.error('Upload error:', error);
            }
        }

        function addNewDocument(file, documentData) {
            const documentList = document.getElementById('documentList');
            const newDoc = document.createElement('div');
            newDoc.className = 'flex items-center justify-between p-4 border border-gray-200 rounded-lg mb-2 bg-gray-50 hover:bg-gray-100 transition-colors';
            newDoc.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 bg-red-500 rounded-lg flex items-center justify-center text-white text-lg">üìÑ</div>
                    <div>
                        <h4 class="font-semibold text-gray-800">${file.name}</h4>
                        <p class="text-sm text-gray-600">${getFileType(file.name)} ‚Ä¢ ${formatFileSize(file.size)} ‚Ä¢ Uploaded just now</p>
                        <p class="text-xs text-gray-500">Status: ${documentData.status}</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600" onclick="editDocument('${documentData._id}')">Edit</button>
                    <button class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600" onclick="deleteDocument('${documentData._id}')">Delete</button>
                </div>
            `;
            documentList.insertBefore(newDoc, documentList.firstChild);
        }

        function getFileType(filename) {
            return filename.split('.').pop().toUpperCase();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateClassification(documentData) {
            // Reload all classifications from server instead of just adding one
            loadExistingDocuments();
        }

        function editDocument(docId) {
            alert(`Edit document: ${docId} - Coming soon!`);
        }

        async function deleteDocument(docId) {
            if (confirm('Are you sure you want to delete this document? This action cannot be undone.')) {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('Please log in to delete documents.');
                        return;
                    }

                    const response = await fetch(`https://labbrain-backend.onrender.com/api/documents/${docId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        alert('Document deleted successfully!');
                        // Reload documents to reflect the deletion
                        loadExistingDocuments();
                    } else {
                        alert('Delete failed: ' + (data.message || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Delete failed: ' + error.message);
                    console.error('Delete error:', error);
                }
            }
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message === '') return;
            
            addMessage(message, 'user');
            input.value = '';
            
            document.getElementById('typingIndicator').style.display = 'block';
            
            try {
                // Get token from localStorage
                const token = localStorage.getItem('token');
                if (!token) {
                    document.getElementById('typingIndicator').style.display = 'none';
                    addMessage('Please log in to use the AI chat.', 'bot');
                    return;
                }
                
                // Call the AI backend
                const response = await fetch('https://labbrain-backend.onrender.com/api/ai/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ message })
                });
                
                const data = await response.json();
                
                document.getElementById('typingIndicator').style.display = 'none';
                
                if (data.success) {
                    addMessage(data.data.response, 'bot');
                    
                    // Add source information if available
                    if (data.data.sources && data.data.sources.length > 0) {
                        const sources = data.data.sources.map(s => s.title).join(', ');
                        addMessage(`üìö Sources: ${sources}`, 'system');
                    }
                } else {
                    addMessage('Sorry, I encountered an error. Please try again.', 'bot');
                }
            } catch (error) {
                document.getElementById('typingIndicator').style.display = 'none';
                addMessage('Sorry, I encountered an error. Please try again.', 'bot');
                console.error('Chat error:', error);
            }
        }

        function addMessage(content, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex items-start gap-3 mb-6';
            if (sender === 'user') messageDiv.className += ' flex-row-reverse';
            
            const avatar = document.createElement('div');
            avatar.className = 'w-10 h-10 rounded-full flex items-center justify-center text-white font-semibold text-sm';
            avatar.style.background = sender === 'user' ? 'linear-gradient(135deg, #ef4444, #dc2626)' : '#10b981';
            avatar.textContent = sender === 'user' ? 'C' : 'AI';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'p-4 rounded-2xl max-w-3/4';
            messageContent.style.background = sender === 'user' ? 'linear-gradient(135deg, #ef4444, #dc2626)' : 'white';
            messageContent.style.color = sender === 'user' ? 'white' : '#374151';
            messageContent.style.border = sender === 'user' ? 'none' : '1px solid #e5e7eb';
            messageContent.textContent = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function generateSupervisorResponse(userMessage) {
            const message = userMessage.toLowerCase();
            
            if (message.includes('upload') || message.includes('document')) {
                return "I can see you've uploaded several documents to the knowledge base: ISO 17025 Calibration Procedures, Equipment Troubleshooting Guide, and Quality Control Standards. These documents are now part of my training data and I can reference them when answering questions.";
            }
            else if (message.includes('iso') || message.includes('17025')) {
                return "Based on the ISO 17025 Calibration Procedures document in the knowledge base, I can provide detailed information about calibration requirements, documentation standards, and compliance procedures. The document covers both management and technical requirements for testing and calibration laboratories.";
            }
            else if (message.includes('troubleshoot') || message.includes('equipment')) {
                return "I have access to the Equipment Troubleshooting Guide which contains comprehensive diagnostic procedures, common issues, and maintenance schedules. I can help users with equipment problems, error diagnosis, and preventive maintenance procedures.";
            }
            else if (message.includes('quality') || message.includes('control')) {
                return "The Quality Control Standards document provides detailed guidelines for quality assurance, control procedures, and compliance requirements. I can assist with quality control protocols, standards implementation, and quality metrics analysis.";
            }
            else if (message.includes('test') || message.includes('knowledge')) {
                return "I'm successfully integrated with the knowledge base you've uploaded. I can now provide accurate, document-based responses to lab-related questions. The AI classification system has categorized the documents appropriately for optimal retrieval.";
            }
            else {
                return "As a supervisor, I have access to all the documents you've uploaded to the knowledge base. I can provide detailed, accurate responses based on the ISO 17025 procedures, troubleshooting guides, and quality control standards. What specific aspect would you like me to explain?";
            }
        }
    </script>
</body>
</html> 
